package com.firewall;

import java.util.Iterator;

import org.apache.commons.lang3.StringUtils;
import org.apache.log4j.Level;
import org.apache.log4j.LogManager;
import org.apache.log4j.Logger;
import org.opennebula.client.Client;
import org.opennebula.client.OneResponse;
import org.opennebula.client.secgroup.SecurityGroup;
import org.opennebula.client.vm.VirtualMachine;

import com.global.Globals;
import com.model.Firewall;
import com.model.FirewallRule;
import com.scanner.EmailSystem;

public class CreateOpenNebulaFirewallFromConfig {

	private static Logger LOGGER = LogManager.getLogger(CreateOpenNebulaFirewallFromConfig.class);

	/*
	 * Open Nebula does not support adding new security groups to VMs which have
	 * already been created. So the only way to apply the security group
	 * firewall is to edit a security group that has been applied to the VM.
	 */
	public void editSecurityGroup(String UUID, String emailAddress, String IP) {

		Client oneClient;
		// Create auth variables from username and password
		String auth = Globals.OpenNebulaCloudUsernameCredential + ":" + Globals.OpenNebulaCloudPasswordCredential;
		LOGGER.log(Level.INFO, "OpenNebula Auth variable: " + auth);
		LOGGER.info("Open Nebula VM UUID: " + UUID);

		try {

			// Create Open Nebula API Client
			oneClient = new Client(auth, Globals.OpenNebulaEndpoint);
			LOGGER.info("Client created");

			// Get VM details
			OneResponse vmInfo = VirtualMachine.info(oneClient, Integer.parseInt(UUID));

			// Get ID of security group applied to the server
			int securityGroupID = getSecurityGroupID(vmInfo.getMessage());
			LOGGER.log(Level.INFO, "Open Nebula Security Group ID: " + securityGroupID);

			// If security group is the default security group then abort
			// applying new rules
			if (securityGroupID == 0) {
				EmailSystem emailSystem = new EmailSystem();
				emailSystem.sendNoCustomSecGroupEmail(UUID, IP, emailAddress);
				return;
			}

			// Retrieve firewall key applied to server
			String firewallKey = getFirewallKey(vmInfo.getMessage());
			Firewall firewall = getConfig(firewallKey);
			// Get corresponding security group template for firewall key
			String secGroup = getSecGroupString(firewall);

			// Update security group with new template
			OneResponse rc3 = SecurityGroup.update(oneClient, securityGroupID, secGroup, false);
			LOGGER.info("Security Group Template applied to Security Group with ID " + rc3.getMessage());

		} catch (Exception e) {
			LOGGER.info("exception hit");
			LOGGER.error(e.getMessage());
		}
	}

	// Match firewall key with template creator string
	public String getSecGroupString(Firewall firewall) {

		//
		LOGGER.info("Firewall being applied: " + firewall.getName());
		String secGroup = "NAME = " + firewall.getName() + "Firewall\n";

		for (int i = 0; i < firewall.getRules().length; i++) {

			FirewallRule currentRule = firewall.getRules()[i];
			secGroup = secGroup + createSecGroupRuleString(currentRule.getProtocol(), currentRule.getDirection(),
					currentRule.getPort());
		}

		return secGroup;

	}

	public String getFirewallKey(String responsemsg) {

		try {

			String delim1 = "<FIREWALL><![CDATA[";
			String delim2 = "]]></FIREWALL>";
			String firewallTag = "default";

			firewallTag = StringUtils.substringBetween(responsemsg, delim1, delim2);
			LOGGER.info("Received Firewall Tag: " + firewallTag);

			if(firewallTag==null)
				return "default";

			else
			return firewallTag;
		}

		catch (Exception e) {

			LOGGER.info("No Firewall tag found");
			return "";
		}
	}

	// Method used to extract security group information from the VM info string
	private int getSecurityGroupID(String responseMsg) {

		if (!responseMsg.equals("null")) {

			String delim1 = "</NIC_ID><SECURITY_GROUPS><![CDATA[";
			String delim2 = "]]>";
			String securityGroupID = "";

			String content = StringUtils.substringBetween(responseMsg, delim1, delim2);
			String[] tokens = content.split(",");
			LOGGER.info("Security Group IDs: ");

			for (int i = 0; i < tokens.length; i++) {

				String current = tokens[i];
				System.out.println(current);
				if (!current.equals("0"))
					securityGroupID = current;
			}

			if (securityGroupID.equals(""))
				return 0;

			return Integer.parseInt(securityGroupID);
		} else
			return 0;
	}

	public Firewall getConfig(String firewallKey) {
		Iterator<Firewall> iterator = Globals.firewalls.iterator();

		while (iterator.hasNext()) {
			Firewall currentFirewall = iterator.next();
			if (currentFirewall.getName().equals(firewallKey))
				return currentFirewall;

		}
		return null;
	}

	public String createSecGroupRuleString(String protocol, String ruleType, int portNumber) {

		String ruleString = "RULE = [PROTOCOL = " + protocol + ", RULE_TYPE = " + ruleType + ", RANGE = " + portNumber
				+ "]\n";
		return ruleString;
	}

}
