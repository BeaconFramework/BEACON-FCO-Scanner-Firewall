package com.flexiant;

import java.io.BufferedReader;
import java.io.InputStreamReader;

import org.apache.log4j.LogManager;
import org.apache.log4j.Logger;

public class DeployChef {
	private static Logger LOGGER = LogManager.getLogger(DeployChef.class);
	//TODO use of SSH key and not name is found.
	//TODO use tag information to deploy role to VM
	private final String Chefrole ="role[secruity]";;
	
	public void deploychefconfig(Request request) {
		boolean Foundusername = request.hasUsername();
		
		if(Foundusername)
		{
		String VMip = request.getIP();
		String  password = request.getIP();
		String username = request.getUsername();
		String command = "/usr/local/bin/knife bootstrap " + VMip + "-N " + VMip + " -x " + username + " -P " + password + " -r "+ '"' +Chefrole +'"'+ " --sudo";		
		String s;
	        Process p;{
	        try {
	        	
	        	p = Runtime.getRuntime().exec(new String[]{"bash", "-c", command});		            
	        	BufferedReader br = new BufferedReader(
	                new InputStreamReader(p.getInputStream()));
	            while ((s = br.readLine()) != null)
	        		LOGGER.info("line: " + s);
	            p.waitFor();
	    		LOGGER.info("Chef exit code: " + p.exitValue());
	            p.destroy();
	        } catch (Exception e) {
	    		LOGGER.info("Chef deployment error Exit with: " + e);
	        }
	    }
	}

	else {
		LOGGER.info("No user name found. Cannot deploy Chef");
	}
}
}